CONTEXT: FILE: lib/start.sh
BRANCH: main

#!/bin/bash
# Ollama startup script (one model per container)

set -e

log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# --- ENV VALIDATION ---
if [ -z "$MODEL_NAME" ]; then
    log "‚ùå ERROR: MODEL_NAME environment variable is required"
    exit 1
fi

if [ "$OFFLINE_MODE" != "true" ] && [ "$OFFLINE_MODE" != "false" ]; then
    log "‚ùå ERROR: OFFLINE_MODE must be 'true' or 'false' ‚Äî got '$OFFLINE_MODE'"
    exit 1
fi

SYSTEM_FILE="/app/modelfiles/system.txt"
TMP_MODELPATH="/tmp/Modelfile"

# --- START OLLAMA SERVER ---
log "üöÄ Starting Ollama server"
export OLLAMA_HOST=0.0.0.0
export OLLAMA_PORT=11434
ollama serve &

# --- WAIT FOR SERVER TO COME ONLINE ---
log "‚è≥ Waiting for Ollama to report readiness on port 11434..."
RETRIES=0
until curl -s "http://localhost:11434" | grep -q "Ollama is running"; do
    sleep 1
    RETRIES=$((RETRIES + 1))
    if [ "$RETRIES" -gt 10 ]; then
        log "‚ùå Ollama did not become ready in 10 seconds."
        curl -v "http://localhost:11434" || true
        ss -ltn || netstat -ltn || true
        exit 1
    fi
done
log "‚úÖ Ollama is reporting ready."

# --- BUILD OR PULL MODEL ---
if [ -f "$SYSTEM_FILE" ]; then
    log "üß± Found system prompt at $SYSTEM_FILE"
    echo "FROM $MODEL_NAME" > "$TMP_MODELPATH"
    echo "" >> "$TMP_MODELPATH"
    cat "$SYSTEM_FILE" >> "$TMP_MODELPATH"

    log "üîç Checking for existing model: $MODEL_NAME"
    EXISTING_MODEL=$(ollama list | awk '{print $1}' | grep -Fx "$MODEL_NAME" || true)

    if [ -n "$EXISTING_MODEL" ]; then
        log "üóëÔ∏è Removing existing model '$MODEL_NAME' for rebuild..."
        if ! ollama rm "$MODEL_NAME"; then
            log "‚ùå Failed to remove model: $MODEL_NAME"
            ollama list
            exit 1
        fi
        log "‚úÖ Removed model: $MODEL_NAME"
    else
        log "‚úÖ No existing model found. Proceeding."
    fi

    log "üî® Building model '$MODEL_NAME' with system prompt..."
    if ! ollama create "$MODEL_NAME" -f "$TMP_MODELPATH"; then
        log "‚ùå Failed to create model"
        exit 1
    fi
    log "‚úÖ Model '$MODEL_NAME' created successfully"
else
    if [ "$OFFLINE_MODE" == "true" ]; then
        log "üîç Checking if model '$MODEL_NAME' is cached locally..."
        if ! ollama list | grep -q "$MODEL_NAME"; then
            log "‚ùå Model '$MODEL_NAME' not found in offline mode"
            exit 1
        fi
        log "‚úÖ Model '$MODEL_NAME' is cached and ready."
    else
        log "üì¶ Pulling model '$MODEL_NAME' from registry..."
        if ! ollama pull "$MODEL_NAME"; then
            log "‚ùå Failed to pull model"
            exit 1
        fi
        log "‚úÖ Model '$MODEL_NAME' successfully pulled."
    fi
fi

log "üèÅ Startup complete. Ollama is serving model: $MODEL_NAME"
wait